<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini AI Assistant | By Lexxcy</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/tokyo-night-dark.min.css" rel="stylesheet" id="code-theme-dark">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/stackoverflow-light.min.css" rel="stylesheet" id="code-theme-light" disabled>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-mml-chtml.js">
</script>
<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-mml-chtml.js">
</script>



</head>
<body>
    <div class="header">
<div class="header-content">
    <div class="profile-container">
        <div class="profile-image">
            <i class="fas fa-robot"></i>
        </div>
        <div class="profile-info">
            <div class="profile-name">Lexccy AI Assistant</div>
        </div>
        <button id="menu-button" class="menu-button">
    <i class="fa-solid fa-clock-rotate-left"></i>
</button>
    </div>

    <!-- Spinner di pojok kanan atas -->
    <div class="spinner-container">
        <div class="spinner">
            <div class="spinnerin"></div>
        </div>
    </div>
</div>
</div>
<div class="sidebar" id="sidebar">
    <div class="sidebar-content">
        <h3>Menu</h3>
        <ul>
            <li><a href="#"><i class="fa-solid fa-house"></i> Home</a></li>
            <li><a href="#"><i class="fa-solid fa-circle-info"></i> About</a></li>
            <li><a href="#"><i class="fa-solid fa-cogs"></i> Services</a></li>
            <li><a href="#"><i class="fa-solid fa-envelope"></i> Contact</a></li>
        </ul>
        
        <h3>Riwayat Chat</h3>
        <div class="chat-buttons">
            <p id="no-chat-message">Tidak ada riwayat chat</p>

</div>


        <ul id="chat-list">
            <li>
                <span class="chat-name">Chat 1</span>
                <button class="delete-chat">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </li>
            <li>
                <span class="chat-name">Chat 2</span>
                <button class="delete-chat">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </li>
        </ul>
    </div>
    
    <!-- Toggle Tema -->
    <div class="theme-toggle-container">
        <button class="theme-toggle" id="theme-toggle">
            <i class="fa-solid fa-moon"></i> <span>Dark Mode</span>
        </button>
    </div>
</div>

<!-- Modal Konfirmasi Hapus -->
<div id="delete-modal" class="modal">
    <div class="modal-content">
        <h3>Konfirmasi Hapus</h3>
        <p>Apakah Anda yakin ingin menghapus chat ini?</p>
        <div class="modal-buttons">
            <button id="confirm-delete">Hapus</button>
            <button id="cancel-delete">Batal</button>
        </div>
    </div>
</div>


    <div class="chat-container" id="chat-container">
        <div class="welcome-message">
            <h2>Welcome to Lexxcy AI Assistant!</h2>
            <p>I'm here to help with information, answer questions, generate creative content, and assist with various tasks. Just type your message below to get started!</p>
        </div>
        <div class="question-suggestions" id="question-suggestions">
    <button onclick="fillAndSend('Apa itu AI?')">Apa itu AI?</button>
    <button onclick="fillAndSend('Bagaimana cara kerja AI?')">Bagaimana cara kerja AI?</button>
    <button onclick="fillAndSend('Apa manfaat AI dalam kehidupan sehari-hari?')">Apa manfaat AI dalam kehidupan sehari-hari?</button>
    <button onclick="fillAndSend('Bagaimana AI belajar dari data?')">Bagaimana AI belajar dari data?</button>
</div>
    </div>

    <div class="toast" id="toast"><i class="fas fa-check-circle"></i> Copied to clipboard!</div><div id="new-chat-container" class="new-chat-container">
    <button id="new-chat-btn"><i class="fa-regular fa-comment-dots"></i> New Chat</button>
</div>

<div class="input-container">
    <div class="input-wrapper">
        <textarea 
            id="prompt" 
            placeholder="Ada pertanyaan ..." 
            rows="1"
            style="resize: none; overflow: hidden;"
            oninput="autoResize(this)"
        ></textarea>
        <button onclick="generateContent()" id="submit-btn">
            <i class="fas fa-paper-plane"></i>
            <span>Send</span>
        </button>
    </div>
</div>



    <script>marked.setOptions({
    highlight: function(code, lang) {
        if (lang && hljs.getLanguage(lang)) {
            return hljs.highlight(code, { language: lang }).value;
        }
        return hljs.highlightAuto(code).value;
    },
    breaks: true
});

let isGenerating = false;
const API_KEY = "AIzaSyBeCuV1Xi2MGYBA_waHBB5RLj_utna_Mio"; // Your API Key

// Store conversation history for multi-turn functionality
let conversationHistory = [];
let currentlyEditing = null;

// Theme toggling functionality
const themeToggle = document.getElementById('theme-toggle');
const rootElement = document.documentElement;
const darkThemeIcon = '<i class="fas fa-moon"></i>';
const lightThemeIcon = '<i class="fas fa-sun"></i>';
const codeThemeDark = document.getElementById('code-theme-dark');
const codeThemeLight = document.getElementById('code-theme-light');

// Check for saved theme preference or use preferred color scheme
const savedTheme = localStorage.getItem('theme');
if (savedTheme === 'light') {
    enableLightTheme();
} else if (savedTheme === 'dark') {
    enableDarkTheme();
} else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
    enableLightTheme();
}

// Theme toggle event listener
themeToggle.addEventListener('click', () => {
    if (rootElement.classList.contains('light-theme')) {
        enableDarkTheme();
    } else {
        enableLightTheme();
    }
});

function enableLightTheme() {
    rootElement.classList.add('light-theme');
    themeToggle.innerHTML = darkThemeIcon;
    if (codeThemeDark) codeThemeDark.disabled = true;
    if (codeThemeLight) codeThemeLight.disabled = false;
    localStorage.setItem('theme', 'light');
    
    // Rehighlight code blocks for the new theme
    document.querySelectorAll('pre code').forEach(block => {
        hljs.highlightElement(block);
    });
}
document.addEventListener("DOMContentLoaded", () => {
    const chatContainer = document.getElementById("chat-container");
    const newChatContainer = document.getElementById("new-chat-container");
    const newChatBtn = document.getElementById("new-chat-btn");

    // **Pastikan tombol "Chat Baru" selalu muncul**
    newChatContainer.style.display = "flex"; 

    function resetChat() {
        chatContainer.innerHTML = ''; // Hapus semua chat

        // Tambahkan kembali Welcome Message & Rekomendasi Pertanyaan
        chatContainer.innerHTML = `
            <div class="welcome-message" id="welcome-message">
                <h2>Welcome to Lexxcy AI Assistant!</h2>
                <p>I'm here to help with information, answer questions, generate creative content, and assist with various tasks. Just type your message below to get started!</p>
            </div>
            <div class="question-suggestions" id="question-suggestions">
                <button onclick="fillAndSend('Apa itu AI?')">Apa itu AI?</button>
                <button onclick="fillAndSend('Bagaimana cara kerja AI?')">Bagaimana cara kerja AI?</button>
                <button onclick="fillAndSend('Apa manfaat AI dalam kehidupan sehari-hari?')">Apa manfaat AI dalam kehidupan sehari-hari?</button>
                <button onclick="fillAndSend('Bagaimana AI belajar dari data?')">Bagaimana AI belajar dari data?</button>
            </div>
        `;
    }

    // **Saat tombol "Chat Baru" diklik, reset chat**
    newChatBtn.addEventListener("click", () => {
        resetChat();
    });
});



function enableDarkTheme() {
    rootElement.classList.remove('light-theme');
    themeToggle.innerHTML = lightThemeIcon;
    if (codeThemeDark) codeThemeDark.disabled = false;
    if (codeThemeLight) codeThemeLight.disabled = true;
    localStorage.setItem('theme', 'dark');
    
    // Rehighlight code blocks for the new theme
    document.querySelectorAll('pre code').forEach(block => {
        hljs.highlightElement(block);
    });
}

function showToast(message) {
    const toast = document.getElementById('toast');
    toast.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2000);
}

function appendMessage(content, isUser = false, originalPrompt = "", messageId = null) {
    const chatContainer = document.getElementById('chat-container');

    // Buat ID unik untuk pesan
    const id = messageId || 'msg-' + Date.now();

    // Bungkus pesan dalam div utama
    const messageWrapper = document.createElement('div');
    messageWrapper.className = `message-wrapper ${isUser ? 'user-message-wrapper' : 'assistant-message-wrapper'}`;
    messageWrapper.id = id;
    messageWrapper.dataset.original = originalPrompt || content;

    // **Tambahkan elemen waktu**
    const timestamp = document.createElement('div');
    timestamp.className = 'chat-timestamp';
    const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    timestamp.textContent = time;

    // Elemen utama pesan
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user-message' : 'assistant-message'}`;
    messageDiv.innerHTML = marked.parse(content);

    // **Buat wadah untuk tombol aksi**
    const buttonContainer = document.createElement('div');
    buttonContainer.className = 'button-container';

    if (isUser) {
        // **Tombol Hapus (Hanya untuk pesan pengguna)**
        const deleteButton = document.createElement('button');
        deleteButton.className = 'icon-button delete-btn';
        deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i>';
        deleteButton.onclick = () => deleteMessage(id);

        // **Tombol Salin**
        const copyButton = document.createElement('button');
        copyButton.className = 'icon-button';
        copyButton.innerHTML = '<i class="fas fa-copy"></i>';
        copyButton.onclick = () => {
            navigator.clipboard.writeText(content)
                .then(() => showToast('Copied to clipboard!'))
                .catch(() => showToast('Failed to copy!'));
        };

        // **Tombol Edit**
        const editButton = document.createElement('button');
        editButton.className = 'icon-button';
        editButton.innerHTML = '<i class="fas fa-edit"></i>';
        editButton.onclick = () => startEditing(id, content);

        // **Tambahkan tombol ke pesan pengguna**
        buttonContainer.appendChild(deleteButton);
        buttonContainer.appendChild(copyButton);
        buttonContainer.appendChild(editButton);
    } else {
        // **Tombol Salin untuk jawaban AI**
        const copyButton = document.createElement('button');
        copyButton.className = 'icon-button';
        copyButton.innerHTML = '<i class="fas fa-copy"></i>';
        copyButton.onclick = () => {
            navigator.clipboard.writeText(content)
                .then(() => showToast('Copied to clipboard!'))
                .catch(() => showToast('Failed to copy!'));
        };

        // **Tombol untuk memodifikasi jawaban AI**
        const shortenButton = document.createElement('button');
        shortenButton.className = 'icon-button';
        shortenButton.innerHTML = '<i class="fas fa-compress"></i> Persingkat';
        shortenButton.onclick = () => modifyResponse(id, "shorten");

        const extendButton = document.createElement('button');
        extendButton.className = 'icon-button';
        extendButton.innerHTML = '<i class="fas fa-expand"></i> Perdetail';
        extendButton.onclick = () => modifyResponse(id, "extend");

        const formalButton = document.createElement('button');
        formalButton.className = 'icon-button';
        formalButton.innerHTML = '<i class="fas fa-pen-fancy"></i> Formal';
        formalButton.onclick = () => modifyResponse(id, "formal");

        buttonContainer.appendChild(copyButton);
        buttonContainer.appendChild(shortenButton);
        buttonContainer.appendChild(extendButton);
        buttonContainer.appendChild(formalButton);
    }

    // **Tambahkan elemen ke dalam pesan**
    messageWrapper.appendChild(timestamp);
    messageWrapper.appendChild(messageDiv);
    messageWrapper.appendChild(buttonContainer);
    chatContainer.appendChild(messageWrapper);
    chatContainer.scrollTop = chatContainer.scrollHeight;

    // Render MathJax jika ada rumus matematika
    MathJax.typesetPromise();

    return id;
}



/**
 * Memodifikasi respon AI berdasarkan mode yang dipilih (shorten, extend, formal)
 * @param {string} messageId - ID elemen pesan yang akan dimodifikasi
 * @param {string} mode - Jenis modifikasi ('shorten', 'extend', 'formal')
 */
async function modifyResponse(messageId, mode) {
    // Cek jika sedang dalam proses generasi
    if (isGenerating) {
        showToast('Sedang memproses, harap tunggu...');
        return;
    }

    const messageWrapper = document.getElementById(messageId);
    if (!messageWrapper) {
        showToast('Pesan tidak ditemukan');
        return;
    }

    // Dapatkan teks asli dari pesan asisten
    const assistantMessage = messageWrapper.querySelector('.assistant-message');
    const originalText = assistantMessage.textContent.trim();

    // Buat prompt modifikasi berdasarkan mode
    let modifiedPrompt = "";
    const modeInstructions = {
        shorten: {
            instruction: "Persingkat teks berikut dengan tetap mempertahankan semua poin penting dan inti informasinya. Buat lebih ringkas tanpa menghilangkan makna:",
            emoji: "↔️"
        },
        extend: {
            instruction: "Jelaskan lebih detail dan panjang teks berikut. Tambahkan contoh, penjelasan, dan informasi pendukung yang relevan:",
            emoji: "🔍"
        },
        formal: {
            instruction: "Ubah teks berikut menjadi lebih formal dan profesional tanpa mengubah makna. Gunakan bahasa baku dan struktur kalimat yang tepat:",
            emoji: "🎩"
        }
    };

    if (!modeInstructions[mode]) {
        showToast('Mode modifikasi tidak valid');
        return;
    }

    modifiedPrompt = `${modeInstructions[mode].instruction}\n\n"${originalText}"`;
    const processingMessage = `${modeInstructions[mode].emoji} Memodifikasi...`;

    isGenerating = true;
    const submitBtn = document.getElementById('submit-btn');
    submitBtn.disabled = true;

    // Tambahkan indikator sedang memproses
    const processingIndicator = document.createElement('div');
    processingIndicator.className = 'processing-indicator';
    processingIndicator.textContent = processingMessage;
    messageWrapper.appendChild(processingIndicator);

    try {
        // Buat history baru untuk permintaan modifikasi
        const modifyHistory = [
            ...conversationHistory,
            {
                role: "user",
                parts: [{ text: modifiedPrompt }]
            }
        ];

        // Kirim permintaan ke API
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                contents: modifyHistory,
                generationConfig: {
                    temperature: mode === 'formal' ? 0.3 : 0.7,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: mode === 'extend' ? 4096 : 2048
                }
            })
        });

        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error?.message || `Error ${response.status}`);
        }

        if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
            const responseText = data.candidates[0].content.parts[0].text;
            
            // Hapus pesan asisten yang lama
            messageWrapper.remove();
            
            // Update conversation history
            conversationHistory = modifyHistory;
            conversationHistory.push({
                role: "model",
                parts: [{ text: responseText }]
            });
            
            // Tampilkan respon yang telah dimodifikasi
            appendMessage(responseText, false, modifiedPrompt);
            
            // Scroll ke pesan baru
            const chatContainer = document.getElementById('chat-container');
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            showToast(`Berhasil memodifikasi respon (${mode})`);
        } else {
            throw new Error("Respon tidak valid dari API");
        }
    } catch (error) {
        console.error("Modify Error:", error);
        showToast(`Gagal memodifikasi: ${error.message}`);
    } finally {
        processingIndicator.remove();
        isGenerating = false;
        submitBtn.disabled = false;
    }
}


function startEditing(messageId, content) {
    if (currentlyEditing) {
        cancelEditing();
    }
    
    const messageWrapper = document.getElementById(messageId);
    const originalContent = messageWrapper.innerHTML;
    currentlyEditing = { id: messageId, originalContent };
    
    // Create editing interface
    const editDiv = document.createElement('div');
    editDiv.className = 'edit-message';
    
    const editTextarea = document.createElement('textarea');
    editTextarea.value = content;
    editTextarea.rows = 3;
    editTextarea.className = 'edit-textarea';
    
    const buttonGroup = document.createElement('div');
    buttonGroup.className = 'edit-buttons';
    
    const saveButton = document.createElement('button');
    saveButton.innerHTML = 'Save';
    saveButton.onclick = () => saveEdit(messageId, editTextarea.value);
    
    const cancelButton = document.createElement('button');
    cancelButton.innerHTML = 'Cancel';
    cancelButton.onclick = cancelEditing;
    
    buttonGroup.appendChild(saveButton);
    buttonGroup.appendChild(cancelButton);
    
    editDiv.appendChild(editTextarea);
    editDiv.appendChild(buttonGroup);
    
    // Replace message with editing interface
    messageWrapper.innerHTML = '';
    messageWrapper.appendChild(editDiv);
    
    editTextarea.focus();
}

function saveEdit(messageId, newContent) {
    if (!newContent.trim()) {
        showToast('Message cannot be empty!');
        return;
    }
    
    // Find the index of this message in the conversation history
    const messageWrapper = document.getElementById(messageId);
    let messageIndex = -1;
    
    for (let i = 0; i < conversationHistory.length; i++) {
        if (conversationHistory[i].role === "user" && i < conversationHistory.length - 1) {
            const nextMessage = conversationHistory[i + 1];
            if (nextMessage.role === "model") {
                messageIndex = i;
                break;
            }
        }
    }
    
    if (messageIndex !== -1) {
        // Remove this message and its response from the conversation history
        const removedMessages = conversationHistory.splice(messageIndex, 2);
        
        // Remove the response message from DOM
        const nextMessageElement = messageWrapper.nextElementSibling;
        if (nextMessageElement && nextMessageElement.classList.contains('assistant-message-wrapper')) {
            nextMessageElement.remove();
        }
        
        // Update user message and get new response
        messageWrapper.innerHTML = currentlyEditing.originalContent;
        currentlyEditing = null;
        
        // Update the text content and get a new response
        const contentElement = messageWrapper.querySelector('.message');
        contentElement.innerHTML = marked.parse(newContent);
        
        // Add buttons back
        const buttonContainer = document.createElement('div');
        buttonContainer.className = 'button-container';
        
        const copyButton = document.createElement('button');
        copyButton.className = 'icon-button';
        copyButton.innerHTML = '<i class="fas fa-copy"></i>';
        copyButton.onclick = () => {
            navigator.clipboard.writeText(newContent)
                .then(() => showToast('Copied to clipboard!'))
                .catch(() => showToast('Failed to copy!'));
        };
        
        const editButton = document.createElement('button');
        editButton.className = 'icon-button';
        editButton.innerHTML = '<i class="fas fa-edit"></i>';
        editButton.onclick = () => {
            startEditing(messageId, newContent);
        };
        
        buttonContainer.appendChild(copyButton);
        buttonContainer.appendChild(editButton);
        contentElement.appendChild(buttonContainer);
        
        // Generate new response
        generateContent(newContent, false, true);
    } else {
        cancelEditing();
    }
}

function cancelEditing() {
    if (currentlyEditing) {
        const messageWrapper = document.getElementById(currentlyEditing.id);
        messageWrapper.innerHTML = currentlyEditing.originalContent;
        currentlyEditing = null;
    }
}

function showTypingIndicator() {
    const chatContainer = document.getElementById('chat-container');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'typing-indicator';
    typingDiv.innerHTML = `
        <div class="typewriter">
            <div class="slide"><i></i></div>
            <div class="paper"></div>
            <div class="keyboard"></div>
        </div>
        <p style="margin-top: 10px; font-size: 0.8rem; color: var(--text-muted)">Lexxcy AI sedang mengetik...</p>
    `;
    chatContainer.appendChild(typingDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
    return typingDiv;
}

function removeTypingIndicator(indicator) {
    if (indicator && indicator.parentElement) {
        indicator.remove();
    }
}

// Replace the existing Enter key event listener with this one
document.getElementById('prompt').addEventListener('keydown', function(event) {
    if (event.key === 'Enter') {
        // Check if Shift key is pressed along with Enter
        if (event.shiftKey) {
            // Default behavior - create a new line and don't send
        } else {
            // If Enter is pressed without Shift, create a new line instead of sending
            event.preventDefault();
            const cursorPosition = this.selectionStart;
            const textBeforeCursor = this.value.substring(0, cursorPosition);
            const textAfterCursor = this.value.substring(cursorPosition);
            
            // Insert a newline character at the cursor position
            this.value = textBeforeCursor + '\n' + textAfterCursor;
            
            // Move the cursor position after the inserted newline
            this.selectionStart = this.selectionEnd = cursorPosition + 1;
            
            // Trigger the auto-resize function
            autoResize(this);
        }
    }
});

// Add a new event listener for Ctrl+Enter to send the message
document.getElementById('prompt').addEventListener('keydown', function(event) {
    // Send message on Ctrl+Enter or Cmd+Enter (for Mac)
    if (event.key === 'Enter' && (event.ctrlKey || event.metaKey)) {
        event.preventDefault();
        generateContent();
    }
});

async function generateContent(prompt = null, isRegenerate = false, isEdit = false) {
    if (isGenerating) return;

    const promptInput = document.getElementById('prompt');
    const submitBtn = document.getElementById('submit-btn');
    let userPrompt = prompt ? prompt : promptInput.value.trim();

    if (!userPrompt) return;

    isGenerating = true;
    promptInput.disabled = true;
    submitBtn.disabled = true;

    // Add user message to chat if not regenerating or editing
    let messageId = null;
    if (!isRegenerate && !isEdit) {
        messageId = appendMessage(userPrompt, true, userPrompt);
        
        // Add to conversation history
        conversationHistory.push({
            role: "user",
            parts: [{ text: userPrompt }]
        });
    } else if (isEdit) {
        // Add edited message to conversation history
        conversationHistory.push({
            role: "user",
            parts: [{ text: userPrompt }]
        });
    }

    const typingIndicator = showTypingIndicator();
    if (!isRegenerate && !isEdit) {
        promptInput.value = '';
        autoResize(promptInput);
    }

    try {
        // Prepare the conversation for multi-turn context
        let requestBody = {
            generationConfig: { 
                temperature: 0.7, 
                topK: 40, 
                topP: 0.95, 
                maxOutputTokens: 2048 
            }
        };
        
        // If regenerating, remove the last assistant response
        if (isRegenerate && conversationHistory.length > 1 && conversationHistory[conversationHistory.length - 1].role === "model") {
            conversationHistory.pop();
        }
        
        // Use contents for multi-turn conversation
        requestBody.contents = conversationHistory;
        
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestBody)
        });

        const data = await response.json();
        removeTypingIndicator(typingIndicator);

        if (!response.ok) {
            appendMessage(`Error: ${data.error?.message || 'Status code ' + response.status}`);
            return;
        }

        if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
            const responseText = data.candidates[0].content.parts[0].text;
            appendMessage(responseText, false, userPrompt);
            
            // Add the response to conversation history
            conversationHistory.push({
                role: "model",
                parts: [{ text: responseText }]
            });
        } else {
            appendMessage("Sorry, I couldn't generate a response for that query.");
        }
    } catch (error) {
        removeTypingIndicator(typingIndicator);
        appendMessage("Error connecting to the API. Please try again.");
        console.error("API Error:", error);
    } finally {
        isGenerating = false;
        promptInput.disabled = false;
        submitBtn.disabled = false;
        promptInput.focus();
    }
}

// Clear chat functionality
function clearChat() {
    const chatContainer = document.getElementById('chat-container');
    chatContainer.innerHTML = `
        <div class="welcome-message">
            <h2>Welcome to Lexxcy AI Assistant!</h2>
            <p>I'm here to help with information, answer questions, generate creative content, and assist with various tasks. Just type your message below to get started!</p>
        </div>
        <div class="question-suggestions" id="question-suggestions">
            <button onclick="fillAndSend('Apa itu AI?')">Apa itu AI?</button>
            <button onclick="fillAndSend('Bagaimana cara kerja AI?')">Bagaimana cara kerja AI?</button>
            <button onclick="fillAndSend('Apa manfaat AI dalam kehidupan sehari-hari?')">Apa manfaat AI dalam kehidupan sehari-hari?</button>
            <button onclick="fillAndSend('Bagaimana AI belajar dari data?')">Bagaimana AI belajar dari data?</button>
        </div>
    `;
    conversationHistory = [];
}


document.addEventListener('DOMContentLoaded', () => {
    const promptInput = document.getElementById('prompt');
    promptInput.focus();
});

window.addEventListener("beforeunload", function (event) {
    event.preventDefault();
    event.returnValue = "Apakah Anda yakin ingin me-refresh halaman? Chat Anda akan hilang.";
});

function autoResize(textarea) {
    textarea.style.height = "auto"; // Reset height for accurate calculation
    const maxHeight = 5 * 24; // Maximum 5 lines (assuming font height is 24px)
    
    if (textarea.scrollHeight > maxHeight) {
        textarea.style.height = maxHeight + "px"; // Limit to max 5 lines
        textarea.style.overflowY = "scroll"; // Enable scroll if more than 5 lines
    } else {
        textarea.style.height = textarea.scrollHeight + "px"; // Adjust height
        textarea.style.overflowY = "hidden"; // Hide scrollbar if less than 5 lines
    }
}



document.addEventListener("DOMContentLoaded", function () {
    const sidebar = document.getElementById("sidebar");
    const menuButton = document.getElementById("menu-button");

    // Tutup sidebar jika klik di luar area sidebar
    document.addEventListener("click", function (event) {
        if (!sidebar.contains(event.target) && !menuButton.contains(event.target)) {
            sidebar.classList.remove("show");
        }
    });

    // Toggle sidebar saat tombol menu diklik
    menuButton.addEventListener("click", function () {
        sidebar.classList.toggle("show");
    });
});


document.addEventListener('touchend', function(event) {
    touchEndX = event.changedTouches[0].clientX;

    // Geser ke kanan (Buka menu)
    if (touchEndX > touchStartX + 50) {
        document.getElementById('sidebar').classList.add('show');
    }



    // Geser ke kiri (Tutup menu)
    if (touchStartX > touchEndX + 50) {
        document.getElementById('sidebar').classList.remove('show');
    }
}, false);

function hideSuggestions() {
    const suggestions = document.getElementById('question-suggestions');
    if (suggestions) {
        suggestions.style.display = 'none';
    }
}

function fillAndSend(question) {
    document.getElementById('prompt').value = question;
    hideSuggestions(); // Sembunyikan rekomendasi saat diklik
    generateContent(); // Kirim pertanyaan
}

document.getElementById('submit-btn').addEventListener('click', function() {
    hideSuggestions(); // Sembunyikan rekomendasi saat pengguna mengirim pertanyaan
});

document.getElementById('prompt').addEventListener('keydown', function(event) {
    if (event.key === 'Enter' && (event.ctrlKey || event.metaKey)) {
        hideSuggestions(); // Sembunyikan rekomendasi jika pengguna mengirim dengan Ctrl+Enter
    }
});

document.addEventListener('DOMContentLoaded', function() {
    // Create and append image upload elements to the input container
    const inputWrapper = document.querySelector('.input-wrapper');
    
    // Create image upload button
    const imageUploadLabel = document.createElement('label');
    imageUploadLabel.className = 'image-upload-btn';
    imageUploadLabel.innerHTML = '<i class="fas fa-image"></i>';
    imageUploadLabel.title = 'Unggah Gambar';
    
    // Create file input element (hidden)
    const imageInput = document.createElement('input');
    imageInput.type = 'file';
    imageInput.id = 'image-upload';
    imageInput.accept = 'image/*';
    imageInput.style.display = 'none';
    
    // Append elements
    imageUploadLabel.appendChild(imageInput);
    inputWrapper.insertBefore(imageUploadLabel, document.getElementById('submit-btn'));
    
    // Image preview container in chat
    const chatContainer = document.getElementById('chat-container');
    
// Di dalam event listener imageInput.addEventListener('change')
imageInput.addEventListener('change', async function(event) {
    if (event.target.files && event.target.files[0]) {
        const file = event.target.files[0];

        // Validate file type
        if (!file.type.match('image.*')) {
            showToast('Hanya file gambar (JPEG, PNG, GIF) yang diperbolehkan');
            return;
        }

        // Create message container
        const messageId = 'img-' + Date.now();
        const messageWrapper = document.createElement('div');
        messageWrapper.className = 'message-wrapper user-message-wrapper';
        messageWrapper.id = messageId;

        const messageDiv = document.createElement('div');
        messageDiv.className = 'message user-message';

        // Add image preview
        const imageUrl = URL.createObjectURL(file);
        const imageElement = document.createElement('img');
        imageElement.src = imageUrl;
        imageElement.className = 'uploaded-image';
        imageElement.alt = 'Gambar yang diunggah';

        // Add command input section
        const commandContainer = document.createElement('div');
        commandContainer.className = 'command-container';

        const commandInput = document.createElement('textarea');
        commandInput.className = 'command-input';
        commandInput.placeholder = 'Tambahkan perintah untuk gambar ini (opsional)...';
        commandInput.rows = 2;

        // Add action buttons
        const actionButtons = document.createElement('div');
        actionButtons.className = 'action-buttons';

        const analyzeButton = document.createElement('button');
        analyzeButton.className = 'analyze-button primary';
        analyzeButton.innerHTML = '<i class="fas fa-search"></i> Analisis';
        
        const cancelButton = document.createElement('button');
        cancelButton.className = 'cancel-button secondary';
        cancelButton.innerHTML = '<i class="fas fa-times"></i> Batal';

        // Button event handlers
        analyzeButton.onclick = async () => {
            const command = commandInput.value.trim();
            
            // Disable button during processing
            analyzeButton.disabled = true;
            analyzeButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';
            
            await processImageWithCommand(file, command, messageId);
            
            // Remove input section after analysis
            commandContainer.remove();
        };

        cancelButton.onclick = () => {
            if (confirm('Batalkan analisis gambar ini?')) {
                messageWrapper.remove();
            }
        };

        // Build the DOM structure
        actionButtons.appendChild(analyzeButton);
        actionButtons.appendChild(cancelButton);
        commandContainer.appendChild(commandInput);
        commandContainer.appendChild(actionButtons);

        messageDiv.appendChild(imageElement);
        messageDiv.appendChild(commandContainer);
        messageWrapper.appendChild(messageDiv);

        // Add to chat container
        const chatContainer = document.getElementById('chat-container');
        chatContainer.appendChild(messageWrapper);
        
        // Scroll to show the new message
        messageWrapper.scrollIntoView({ behavior: 'smooth' });

        // Focus on command input
        commandInput.focus();

        // Handle Enter key in command input
        commandInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                analyzeButton.click();
            }
        });
    }
});

// Function to process image with command
async function processImageWithCommand(imageFile, command = "", messageId, isFromCamera = false) {
    const typingIndicator = showTypingIndicator();
    
    try {
        const base64Image = await convertToBase64(imageFile);
        
        const requestBody = {
            contents: [
                {
                    role: "user",
                    parts: [
                        { text: command || "Tolong jelaskan apa yang Anda lihat dalam gambar ini:" },
                        {
                            inline_data: {
                                mime_type: imageFile.type,
                                data: base64Image.split(',')[1]
                            }
                        }
                    ]
                }
            ],
            generationConfig: { 
                temperature: 0.7, 
                topK: 40, 
                topP: 0.95, 
                maxOutputTokens: 2048 
            }
        };
        
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestBody)
        });
        
        const data = await response.json();
        removeTypingIndicator(typingIndicator);
        
        if (!response.ok) {
            appendMessage(`Error memproses gambar: ${data.error?.message || 'Status code ' + response.status}`);
            return;
        }
        
        if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
            const responseText = data.candidates[0].content.parts[0].text;
            appendMessage(responseText, false, command || "Analisis Gambar");
            
            // Update message with command text if from camera
            if (isFromCamera) {
                const messageWrapper = document.getElementById(messageId);
                if (messageWrapper) {
                    const commandText = document.createElement('div');
                    commandText.className = 'image-command-text';
                    commandText.textContent = `Perintah: ${command || "Analisis gambar"}`;
                    messageWrapper.querySelector('.message').appendChild(commandText);
                }
            }
            
            // Add to conversation history
            conversationHistory.push({
                role: "user",
                parts: [
                    { text: command || "Analisis gambar ini:" },
                    {
                        inline_data: {
                            mime_type: imageFile.type,
                            data: base64Image.split(',')[1]
                        }
                    }
                ]
            });
            
            conversationHistory.push({
                role: "model",
                parts: [{ text: responseText }]
            });
        } else {
            appendMessage("Maaf, saya tidak dapat menganalisis gambar dengan benar.");
        }
    } catch (error) {
        removeTypingIndicator(typingIndicator);
        appendMessage("Error memproses gambar. Silakan coba lagi.");
        console.error("Image Processing Error:", error);
    }
}

// Helper function to convert image to base64
function convertToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
    });
}
    
    // Function to process image and get AI response
// Modifikasi fungsi processImageWithCommand
async function processImageWithCommand(imageFile, command = "", messageId, isFromCamera = false) {
    const typingIndicator = showTypingIndicator();
    
    try {
        const base64Image = await convertToBase64(imageFile);
        
        const requestBody = {
            contents: [
                {
                    role: "user",
                    parts: [
                        { text: command || "Tolong jelaskan apa yang Anda lihat dalam gambar ini:" },
                        {
                            inline_data: {
                                mime_type: imageFile.type,
                                data: base64Image.split(',')[1]
                            }
                        }
                    ]
                }
            ],
            generationConfig: { 
                temperature: 0.7, 
                topK: 40, 
                topP: 0.95, 
                maxOutputTokens: 2048 
            }
        };
        
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestBody)
        });
        
        const data = await response.json();
        removeTypingIndicator(typingIndicator);
        
        if (!response.ok) {
            appendMessage(`Error memproses gambar: ${data.error?.message || 'Status code ' + response.status}`);
            return;
        }
        
        if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
            const responseText = data.candidates[0].content.parts[0].text;
            
            // Dapatkan elemen pesan asli yang berisi gambar
            const originalMessage = document.getElementById(messageId);
            if (originalMessage) {
                // Tambahkan teks perintah di bawah gambar
                const commandText = document.createElement('div');
                commandText.className = 'image-command-text';
                commandText.innerHTML = `<strong>Perintah:</strong> ${command || "Analisis gambar"}`;
                
                // Temukan div message di dalam wrapper
                const messageDiv = originalMessage.querySelector('.message');
                if (messageDiv) {
                    // Sisipkan teks perintah setelah gambar tapi sebelum tombol (jika ada)
                    const img = messageDiv.querySelector('img');
                    if (img) {
                        img.insertAdjacentElement('afterend', commandText);
                    } else {
                        messageDiv.insertBefore(commandText, messageDiv.firstChild);
                    }
                }
            }
            
            // Tambahkan jawaban AI
            appendMessage(responseText, false);
            
            // Tambahkan ke riwayat percakapan
            conversationHistory.push({
                role: "user",
                parts: [
                    { text: command || "Analisis gambar ini:" },
                    {
                        inline_data: {
                            mime_type: imageFile.type,
                            data: base64Image.split(',')[1]
                        }
                    }
                ]
            });
            
            conversationHistory.push({
                role: "model",
                parts: [{ text: responseText }]
            });
        } else {
            appendMessage("Maaf, saya tidak dapat menganalisis gambar dengan benar.");
        }
    } catch (error) {
        removeTypingIndicator(typingIndicator);
        appendMessage("Error memproses gambar. Silakan coba lagi.");
        console.error("Image Processing Error:", error);
    }
}
    
    // Convert image file to base64
    function convertToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
            reader.readAsDataURL(file);
        });
    }
    
// Camera capture functionality
if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    let stream = null;
    let useFrontCamera = false;

    // Create camera button
    const cameraButton = document.createElement('button');
    cameraButton.className = 'camera-btn';
    cameraButton.innerHTML = '<i class="fas fa-camera"></i>';
    cameraButton.title = 'Ambil Foto';
    inputWrapper.insertBefore(cameraButton, document.getElementById('submit-btn'));

    // Camera modal
    const cameraModal = document.createElement('div');
    cameraModal.className = 'camera-modal';
    cameraModal.style.display = 'none';

    const modalContent = document.createElement('div');
    modalContent.className = 'camera-modal-content';

    const videoElement = document.createElement('video');
    videoElement.autoplay = true;
    videoElement.playsInline = true;
    videoElement.className = 'camera-video';

    const buttonContainer = document.createElement('div');
    buttonContainer.className = 'camera-controls';

    // Tombol Close
    const closeButton = document.createElement('button');
    closeButton.className = 'camera-close-btn';
    closeButton.innerHTML = '<i class="fas fa-times"></i>';
    closeButton.title = 'Tutup Kamera';

    // Tombol Ganti Kamera
    const switchButton = document.createElement('button');
    switchButton.className = 'camera-switch-btn';
    switchButton.innerHTML = '<i class="fas fa-sync-alt"></i>';
    switchButton.title = 'Ganti Kamera';

    // Tombol Ambil Foto (besar di tengah)
    const captureButton = document.createElement('button');
    captureButton.className = 'camera-capture-btn';
    captureButton.innerHTML = '<i class="fas fa-circle"></i>';
    captureButton.title = 'Ambil Foto';

    const canvasElement = document.createElement('canvas');
    canvasElement.className = 'camera-canvas';
    canvasElement.style.display = 'none';

    modalContent.appendChild(videoElement);
    modalContent.appendChild(buttonContainer);
    modalContent.appendChild(canvasElement);
    
    buttonContainer.appendChild(closeButton);
    buttonContainer.appendChild(captureButton);
    buttonContainer.appendChild(switchButton);
    
    cameraModal.appendChild(modalContent);
    document.body.appendChild(cameraModal);

    // Open camera function
    async function openCamera() {
        try {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            stream = await navigator.mediaDevices.getUserMedia({
                video: { 
                    facingMode: useFrontCamera ? 'user' : 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            });
            videoElement.srcObject = stream;
            videoElement.style.display = 'block';
            canvasElement.style.display = 'none';
            cameraModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        } catch (error) {
            console.error('Camera error:', error);
            showToast('Tidak dapat mengakses kamera: ' + error.message);
        }
    }

    // Close camera function
    function closeCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
        cameraModal.style.display = 'none';
        document.body.style.overflow = '';
    }

    // Event listeners
    cameraButton.addEventListener('click', openCamera);
    
    switchButton.addEventListener('click', () => {
        useFrontCamera = !useFrontCamera;
        openCamera();
    });

    closeButton.addEventListener('click', closeCamera);

    captureButton.addEventListener('click', () => {
        const context = canvasElement.getContext('2d');
        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;
        context.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);

        canvasElement.toBlob((blob) => {
            closeCamera();
            
            // Buat wadah pesan untuk gambar dari kamera
            const messageId = 'msg-' + Date.now();
            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'message-wrapper user-message-wrapper';
            messageWrapper.id = messageId;

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user-message';

            const imageElement = document.createElement('img');
            imageElement.src = URL.createObjectURL(blob);
            imageElement.className = 'uploaded-image';
            imageElement.alt = 'Gambar dari kamera';

            const confirmationDiv = document.createElement('div');
            confirmationDiv.className = 'message-confirmation';

            const commandInput = document.createElement('textarea');
            commandInput.className = 'command-input';
            commandInput.placeholder = 'Tambahkan perintah untuk gambar ini...';
            commandInput.rows = 2;

            const buttonGroup = document.createElement('div');
            buttonGroup.className = 'confirmation-buttons';

            const sendButton = document.createElement('button');
            sendButton.className = 'confirm-send-btn';
            sendButton.innerHTML = '<i class="fas fa-paper-plane"></i> Analisis';

            const cancelButton = document.createElement('button');
            cancelButton.className = 'cancel-send-btn';
            cancelButton.innerHTML = '<i class="fas fa-times"></i> Batal';

            buttonGroup.appendChild(sendButton);
            buttonGroup.appendChild(cancelButton);
            confirmationDiv.appendChild(commandInput);
            confirmationDiv.appendChild(buttonGroup);

            messageDiv.appendChild(imageElement);
            messageDiv.appendChild(confirmationDiv);
            messageWrapper.appendChild(messageDiv);

            const chatContainer = document.getElementById('chat-container');
            chatContainer.appendChild(messageWrapper);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            sendButton.addEventListener('click', function() {
                const command = commandInput.value.trim();
                const file = new File([blob], "camera-capture.jpg", { type: "image/jpeg" });
                confirmationDiv.remove();
                processImageWithCommand(file, command, messageId, true);
            });

            cancelButton.addEventListener('click', function() {
                messageWrapper.remove();
            });
            
            commandInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendButton.click();
                }
            });
        }, 'image/jpeg', 0.9);
    });
}
    
    // Translation function
    async function translateToIndonesian(text) {
        try {
            const response = await fetch(`https://translation.googleapis.com/language/translate/v2?key=${API_KEY}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    q: text,
                    source: 'en',
                    target: 'id',
                    format: 'text'
                })
            });
            
            const data = await response.json();
            
            if (data.data && data.data.translations && data.data.translations.length > 0) {
                return data.data.translations[0].translatedText;
            } else {
                console.error('Translation error:', data);
                return text; // Return original text if translation fails
            }
        } catch (error) {
            console.error('Translation service error:', error);
            return text; // Return original text if translation fails
        }
    }
    
    // Modify the original submit button behavior
    const originalSubmitButton = document.getElementById('submit-btn');
    const originalForm = document.querySelector('form');
    
    if (originalForm) {
        // Remove the original form submit event
        originalForm.onsubmit = null;
        
        // Add new submit event
        originalForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const userInput = document.getElementById('user-input');
            const message = userInput.value.trim();
            
            if (message) {
                // Create message preview with confirmation
                const messageId = 'msg-' + Date.now();
                const messageWrapper = document.createElement('div');
                messageWrapper.className = 'message-wrapper user-message-wrapper';
                messageWrapper.id = messageId;
                
                // Create message content
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message user-message';
                messageDiv.textContent = message;
                
                // Add confirmation buttons
                const confirmationDiv = document.createElement('div');
                confirmationDiv.className = 'message-confirmation';
                
                const sendButton = document.createElement('button');
                sendButton.className = 'confirm-send-btn';
                sendButton.innerHTML = '<i class="fas fa-paper-plane"></i> Kirim';
                
                const cancelButton = document.createElement('button');
                cancelButton.className = 'cancel-send-btn';
                cancelButton.innerHTML = '<i class="fas fa-times"></i> Batal';
                
                const editButton = document.createElement('button');
                editButton.className = 'edit-message-btn';
                editButton.innerHTML = '<i class="fas fa-edit"></i> Edit';
                
                confirmationDiv.appendChild(sendButton);
                confirmationDiv.appendChild(editButton);
                confirmationDiv.appendChild(cancelButton);
                
                // Append elements
                messageDiv.appendChild(confirmationDiv);
                messageWrapper.appendChild(messageDiv);
                chatContainer.appendChild(messageWrapper);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                // Clear input field
                userInput.value = '';
                
                // Send button event listener
                sendButton.addEventListener('click', function() {
                    // Remove confirmation buttons
                    confirmationDiv.remove();
                    
                    // Process the message
                    window.processMessage(message);
                });
                
                // Edit button event listener
                editButton.addEventListener('click', function() {
                    // Put the message back in the input field
                    userInput.value = message;
                    userInput.focus();
                    
                    // Remove the message from chat
                    messageWrapper.remove();
                });
                
                // Cancel button event listener
                cancelButton.addEventListener('click', function() {
                    // Remove the message from chat
                    messageWrapper.remove();
                });
            }
        });
    }
    
    // Override the message processing function to translate responses to Indonesian
    const originalProcessMessage = window.processMessage;
    window.processMessage = async function(message) {
        // Show typing indicator
        const typingIndicator = showTypingIndicator();
        
        try {
            // Get AI response in English
            const response = await originalGetAIResponse(message);
            removeTypingIndicator(typingIndicator);
            
            // Translate the response to Indonesian
            const translatedResponse = await translateToIndonesian(response);
            
            // Append the translated message
            appendMessage(translatedResponse, false);
            
            // Add to conversation history
            conversationHistory.push({
                role: "user",
                parts: [{ text: message }]
            });
            
            conversationHistory.push({
                role: "model",
                parts: [{ text: translatedResponse }]
            });
            
            // Clear input
            document.getElementById('user-input').value = '';
            
            // Reset thinking dots
            resetThinkingDots();
        } catch (error) {
            removeTypingIndicator(typingIndicator);
            appendMessage("Maaf, ada masalah dalam memproses pesan Anda. Silakan coba lagi.");
            console.error("Error:", error);
        }
    };
    
    // Save the original getAIResponse function
    const originalGetAIResponse = window.getAIResponse;
    
    // Update UI elements with Indonesian language
    function updateUIToIndonesian() {
        // Update placeholders
        const userInput = document.getElementById('user-input');
        if (userInput) {
            userInput.placeholder = 'Ketik pesan Anda di sini...';
        }
        
        // Update button text/titles
        const submitBtn = document.getElementById('submit-btn');
        if (submitBtn) {
            submitBtn.title = 'Kirim';
        }
        
        // Update other UI elements
        const welcomeMessage = document.querySelector('.welcome-message');
        if (welcomeMessage) {
            welcomeMessage.innerHTML = `
                <h2>Selamat Datang di Lexxcy AI Assistant!</h2>
                <p>Saya asisten AI Anda yang dapat membantu Anda dengan berbagai tugas. Tanyakan apa saja!.Anda juga dapat mengunggah gambar, dan saya akan mencoba menganalisisnya untuk Anda.</p>
            `;
        }
    }
    
    // Call the function to update UI
    updateUIToIndonesian();
    
    // Show toast messages in Indonesian
    window.showToast = function(message, duration = 3000) {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.classList.add('show');
        }, 10);
        
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 300);
        }, duration);
    };
    
    // Add CSS for confirmation buttons and other new elements
    const style = document.createElement('style');
    style.textContent = `
        /* Additional styling for Indonesian text if needed */
        .message {
            font-family: 'Roboto', 'Noto Sans', sans-serif;
            position: relative;
        }
        
        .camera-modal .capture-btn {
            background-color: #4CAF50;
        }
        
        .camera-modal .close-btn {
            background-color: #f44336;
        }
        
        .message-confirmation {
            display: flex;
            justify-content: flex-end;
            margin-top: 8px;
            gap: 8px;
        }
        
        .confirm-send-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .edit-message-btn {
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .cancel-send-btn {
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .confirm-send-btn:hover, .edit-message-btn:hover, .cancel-send-btn:hover {
            opacity: 0.9;
        }
    `;
    document.head.appendChild(style);
});
document.addEventListener('DOMContentLoaded', function() {
    let draggingCounter = 0; // Untuk mendeteksi kapan drag selesai

    // Saat file mulai diseret ke halaman
    document.addEventListener('dragover', function(event) {
        event.preventDefault();
        if (draggingCounter === 0) {
            document.body.classList.add('dragging'); // Tambah efek latar
        }
        draggingCounter++;
    });

    // Saat file keluar dari halaman tanpa dijatuhkan
    document.addEventListener('dragleave', function() {
        draggingCounter--;
        if (draggingCounter === 0) {
            document.body.classList.remove('dragging'); // Hapus efek latar
        }
    });

    // Saat file dijatuhkan di mana saja di halaman
    document.addEventListener('drop', function(event) {
        event.preventDefault();
        document.body.classList.remove('dragging');
        draggingCounter = 0; // Reset counter

        let files = event.dataTransfer.files;

        if (files.length === 1 && files[0].type.startsWith('image/')) {
            // Jika hanya satu gambar, tampilkan di chat
            previewAndSendImage(files[0]);
        } else {
            // Jika bukan gambar atau lebih dari satu file, tampilkan jumlah file
            appendMessage(`Anda mengunggah ${files.length} file.`, false);
        }
    });

    function previewAndSendImage(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const chatContainer = document.getElementById('chat-container');
            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'message-wrapper user-message-wrapper';

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user-message';

            const imageElement = document.createElement('img');
            imageElement.src = e.target.result;
            imageElement.className = 'uploaded-image';
            imageElement.alt = 'Gambar yang diunggah';

            messageDiv.appendChild(imageElement);
            messageWrapper.appendChild(messageDiv);
            chatContainer.appendChild(messageWrapper);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        };
        reader.readAsDataURL(file);
    }
});
function formatResponse(text) {
    // **Bold** dan *Italic* hanya jika terdapat spasi sebelum atau setelahnya
    text = text.replace(/(?<=\s|\n)\*\*(.*?)\*\*(?=\s|\n)/g, '<strong>$1</strong>'); // **bold**
    text = text.replace(/(?<=\s|\n)\*(.*?)\*(?=\s|\n)/g, '<em>$1</em>'); // *italic*

    // Judul Markdown
    text = text.replace(/^### (.*$)/gim, '<h3>$1</h3>'); // H3
    text = text.replace(/^## (.*$)/gim, '<h2>$1</h2>'); // H2
    text = text.replace(/^# (.*$)/gim, '<h1>$1</h1>'); // H1

    // Kutipan (>)
    text = text.replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>');

    // Daftar Bullet (Menghindari pengubahan teks yang mengandung *)
    text = text.replace(/^\s*\*\s(.*$)/gim, '<ul><li>$1</li></ul>');
    text = text.replace(/<\/ul>\s*<ul>/g, ''); // Gabungkan daftar bertingkat

    // Daftar Angka (1. item)
    text = text.replace(/^\s*\d+\.\s(.*$)/gim, '<ol><li>$1</li></ol>');
    text = text.replace(/<\/ol>\s*<ol>/g, ''); // Gabungkan daftar bertingkat

    // Blok Kode (``` kode ```)
    text = text.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');

    // Hilangkan bintang (*) yang tidak digunakan untuk pemformatan
    text = text.replace(/(?<!\w)\*(?!\w)/g, '');

    // Gantikan newline (\n) dengan <br> jika tidak dalam elemen kode atau daftar
    text = text.replace(/(?<!<\/?(?:h1|h2|h3|ul|ol|li|blockquote|pre|code)>)\n/g, '<br>');

    return text;
}

function formatTable(content) {
    // Cek apakah ada tabel dalam format Markdown
    if (content.includes('|') && content.includes('---')) {
        let formattedContent = content
            .replace(/\|/g, '</td><td>') // Ganti | dengan <td>
            .replace(/<\/td><td>---<\/td><td>/g, '</th></tr><tr><td>') // Ganti separator
            .replace(/<td>---<\/td>/g, '<th>') // Ganti header
            .replace(/<\/td><td>---<\/td>/g, '</th><th>') // Perbaiki header

        return `<div class="table-container">
                    <table class="ai-table">
                        <tr><th>${formattedContent}</td></tr>
                    </table>
                </div>`;
    }
    return content;
}

const chatSidebar = document.getElementById('chat-sidebar');
const chatList = document.getElementById('chat-list');
const newChatBtn = document.getElementById('new-chat-btn');
const deleteModal = document.getElementById('delete-modal');
const confirmDeleteBtn = document.getElementById('confirm-delete');
const cancelDeleteBtn = document.getElementById('cancel-delete');

let chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
let currentChatIndex = null;
let chatToDelete = null;

// **Tampilkan Sidebar Saat Geser ke Kanan**
document.addEventListener('touchstart', (e) => {
    if (e.touches[0].clientX < 50) {
        chatSidebar.classList.add('show');
    }
});

// **Fungsi Menyimpan Chat dengan Nama Otomatis**
let currentChatId = null; // ID chat yang sedang aktif

function saveChatToHistory() {
    const messages = Array.from(document.querySelectorAll('.message-wrapper')).map(msg => {
        const messageDiv = msg.querySelector('.message');
        let content = '';
        let imageUrl = '';
        
        // Cek apakah ada gambar dalam pesan
        const img = messageDiv.querySelector('img');
        if (img) {
            imageUrl = img.src;
            content = messageDiv.textContent.trim(); // Teks yang menyertai gambar
        } else {
            content = messageDiv.textContent.trim();
        }
        
        return {
            content: content,
            isUser: msg.classList.contains('user-message-wrapper'),
            timestamp: msg.querySelector('.chat-timestamp')?.textContent || '',
            imageUrl: imageUrl
        };
    });

    if (messages.length === 0) return;

    // Jika chat sedang aktif, update yang ada
    if (currentChatId !== null) {
        const index = chatHistory.findIndex(chat => chat.id === currentChatId);
        if (index !== -1) {
            chatHistory[index].messages = messages;
            chatHistory[index].lastUpdated = new Date().toISOString();
        }
    } else {
        // Buat chat baru
        const chatTitle = messages[0].content.substring(0, 20) + 
                         (messages[0].content.length > 20 ? "..." : "") + 
                         (messages[0].imageUrl ? " [Gambar]" : "");
        chatHistory.push({
            id: Date.now().toString(),
            title: chatTitle,
            messages: messages,
            created: new Date().toISOString(),
            lastUpdated: new Date().toISOString()
        });
    }
    
    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
    renderChatHistory();
}

function renderChatHistory() {
    const chatList = document.getElementById('chat-list');
    chatList.innerHTML = '';
    
    if (chatHistory.length === 0) {
        document.getElementById('no-chat-message').style.display = 'block';
        return;
    }
    
    document.getElementById('no-chat-message').style.display = 'none';
    
    // Urutkan berdasarkan waktu terbaru
    chatHistory.sort((a, b) => new Date(b.lastUpdated) - new Date(a.lastUpdated));
    
    chatHistory.forEach(chat => {
        const listItem = document.createElement('li');
        listItem.dataset.chatId = chat.id;
        
        // Wrapper untuk judul dan waktu
        const titleWrapper = document.createElement('div');
        titleWrapper.className = 'chat-title-wrapper';
        
        const title = document.createElement('span');
        title.className = 'chat-title';
        
        // Tambahkan ikon gambar jika chat mengandung gambar
        const hasImages = chat.messages.some(msg => msg.imageUrl);
        title.textContent = chat.title + (hasImages ? ' [Gambar]' : '');
        
        const time = document.createElement('span');
        time.className = 'chat-time';
        time.textContent = formatRelativeTime(chat.lastUpdated);
        
        titleWrapper.appendChild(title);
        titleWrapper.appendChild(time);
        
        // Tombol hapus
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-chat';
        deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
        deleteBtn.onclick = (e) => {
            e.stopPropagation();
            deleteChat(chat.id);
        };
        
        listItem.appendChild(titleWrapper);
        listItem.appendChild(deleteBtn);
        
        // Highlight chat aktif
        if (currentChatId === chat.id) {
            listItem.classList.add('active');
            listItem.querySelector('.delete-chat').style.opacity = '1';
        }
        
        listItem.addEventListener('click', () => loadChat(chat.id));
        chatList.appendChild(listItem);
    });
    
    // Auto-update waktu setiap menit
    setTimeout(renderChatHistory, 60000);
}

// Panggil fungsi ini saat halaman dimuat dan setiap kali ada perubahan riwayat chat
document.addEventListener('DOMContentLoaded', renderChatHistory);

function formatRelativeTime(timestamp) {
    const now = new Date();
    const messageTime = new Date(timestamp);
    const diffInSeconds = Math.floor((now - messageTime) / 1000);
    
    if (diffInSeconds < 60) {
        return 'Baru saja';
    } else if (diffInSeconds < 3600) {
        const minutes = Math.floor(diffInSeconds / 60);
        return `${minutes} menit lalu`;
    } else if (diffInSeconds < 86400) {
        const hours = Math.floor(diffInSeconds / 3600);
        return `${hours} jam lalu`;
    } else {
        return messageTime.toLocaleDateString('id-ID', {
            day: 'numeric',
            month: 'short'
        });
    }
}
document.getElementById('new-chat-btn').addEventListener('click', function() {
    const messages = document.querySelectorAll('.message-wrapper');
    
    // Hanya simpan ke riwayat jika ada percakapan
    if (messages.length > 0) {
        saveChatToHistory();
    }
    
    // Reset chat
    clearChat();
    currentChatIndex = null;
    
    // Perbarui tampilan
    const noChatMessage = document.getElementById('no-chat-message');
    if (noChatMessage) noChatMessage.style.display = 'block';
});

function checkEmptyChat() {
    const messages = document.querySelectorAll('.message-wrapper');
    const noChatMessage = document.getElementById('no-chat-message');
    
    if (messages.length === 0 && noChatMessage) {
        noChatMessage.style.display = 'block';
    } else if (noChatMessage) {
        noChatMessage.style.display = 'none';
    }
}

// Fungsi untuk mengecek apakah masih ada chat dalam daftar
function checkChatList() {
    const noChatMessage = document.getElementById('no-chat-message');
    const chatList = document.getElementById('chat-list');

    if (chatList.children.length === 0) {
        noChatMessage.style.display = 'block';
    }
}
function checkChatHistory() {
    const noChatMessage = document.getElementById('no-chat-message');
    const chatList = document.getElementById('chat-list');
    
    if (chatList.children.length === 0) {
        noChatMessage.style.display = 'block';
    } else {
        noChatMessage.style.display = 'none';
    }
}
// Cek status saat halaman dimuat
document.addEventListener("DOMContentLoaded", checkChatList);


// **Fungsi Memuat Chat Lama dengan Efek Transisi**
function loadChat(chatId) {
    // Jika ada perubahan yang belum disimpan di chat saat ini, simpan dulu
    if (currentChatId && hasUnsavedChanges(currentChatId)) {
        saveChatToHistory();
    }
    
    const chat = chatHistory.find(c => c.id === chatId);
    if (!chat) return;

    currentChatId = chatId;
    clearChat();
    
    // Load messages from history
    chat.messages.forEach(msg => {
        if (msg.imageUrl) {
            // Jika pesan mengandung gambar
            const messageId = appendMessage(msg.content || "Gambar yang diunggah", msg.isUser);
            const messageWrapper = document.getElementById(messageId);
            const messageDiv = messageWrapper.querySelector('.message');
            
            const imageElement = document.createElement('img');
            imageElement.src = msg.imageUrl;
            imageElement.className = 'uploaded-image';
            imageElement.alt = 'Gambar yang diunggah';
            
            // Sisipkan gambar sebelum teks
            messageDiv.insertBefore(imageElement, messageDiv.firstChild);
        } else {
            // Pesan teks biasa
            appendMessage(msg.content, msg.isUser);
        }
    });
    
    // Sembunyikan welcome message
    document.querySelector('.welcome-message').style.display = 'none';
    document.querySelector('.question-suggestions').style.display = 'none';
    
    // Perbarui tampilan riwayat chat
    renderChatHistory();
}

function createNewChat() {
    // Simpan perubahan chat sebelumnya
    if (currentChatId !== null) {
        saveChatToHistory();
    }
    
    // Reset state
    currentChatId = null;
    conversationHistory = [];
    clearChat();
    
    // Tampilkan elemen awal
    document.querySelector('.welcome-message').style.display = 'block';
    document.querySelector('.question-suggestions').style.display = 'flex';
}

// **Fungsi Menampilkan Modal Konfirmasi Hapus**
function showDeleteModal(index) {
    chatToDelete = index;
    deleteModal.classList.add("show");
}

// **Fungsi Menghapus Chat Setelah Konfirmasi**
confirmDeleteBtn.addEventListener('click', () => {
    if (chatToDelete !== null) {
        chatHistory.splice(chatToDelete, 1);
        localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
        renderChatHistory();
        deleteModal.classList.remove("show");
        chatToDelete = null;
    }
});

// **Fungsi Membatalkan Penghapusan**
cancelDeleteBtn.addEventListener('click', () => {
    deleteModal.classList.remove("show");
    chatToDelete = null;
});

// **Fungsi Membuat Chat Baru**
newChatBtn.addEventListener('click', () => {
    saveChatToHistory();
    clearChat();
    currentChatIndex = null;
});
function deleteChat(chatId) {
    chatHistory = chatHistory.filter(chat => chat.id !== chatId);
    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
    renderChatHistory();
    
    if (currentChatId === chatId) {
        createNewChat();
    }
}
// **Render Riwayat Chat Saat Halaman Dimuat**
document.addEventListener('DOMContentLoaded', renderChatHistory);
function deleteMessage(messageId) {
    const messageWrapper = document.getElementById(messageId);
    if (!messageWrapper) return;

    const nextMessage = messageWrapper.nextElementSibling;

    // Tambahkan efek animasi sebelum menghapus elemen
    messageWrapper.style.transition = "opacity 0.3s ease, transform 0.3s ease";
    messageWrapper.style.opacity = "0";
    messageWrapper.style.transform = "translateY(-10px) scale(0.9)";

    setTimeout(() => {
        // Jika pesan yang dihapus adalah dari pengguna, hapus juga jawaban AI setelahnya
        if (messageWrapper.classList.contains('user-message-wrapper') && 
            nextMessage && nextMessage.classList.contains('assistant-message-wrapper')) {
            nextMessage.style.transition = "opacity 0.3s ease, transform 0.3s ease";
            nextMessage.style.opacity = "0";
            nextMessage.style.transform = "translateY(-10px) scale(0.9)";
            setTimeout(() => nextMessage.remove(), 300);
        }

        messageWrapper.remove();
        checkEmptyChat(); // Cek apakah chat kosong
    }, 300); // Waktu sesuai dengan durasi animasi
}

document.getElementById('clear-chat-btn').addEventListener('click', function() {
    clearChat();
    showToast('Semua riwayat chat telah dihapus!');
});

// Fungsi untuk menghapus semua chat
function clearChat() {
    const chatContainer = document.getElementById('chat-container');
    chatContainer.innerHTML = `
        <div class="welcome-message">
            <h2>Welcome to Lexxcy AI Assistant!</h2>            <p>I'm here to help with information, answer questions, generate creative content, and assist with various tasks. Just type your message below to get started!</p>
        </div>
        <div class="question-suggestions" id="question-suggestions">
    <button onclick="fillAndSend('Apa itu AI?')">Apa itu AI?</button>
    <button onclick="fillAndSend('Bagaimana cara kerja AI?')">Bagaimana cara kerja AI?</button>
    <button onclick="fillAndSend('Apa manfaat AI dalam kehidupan sehari-hari?')">Apa manfaat AI dalam kehidupan sehari-hari?</button>
    <button onclick="fillAndSend('Bagaimana AI belajar dari data?')">Bagaimana AI belajar dari data?</button>
</div>
    </div>

        </div>
    `;
    
    conversationHistory = [];
    checkEmptyChat(); // Panggil pengecekan chat kosong
}
document.addEventListener("DOMContentLoaded", () => {
    checkEmptyChat();
    // Panggil ini setiap ada perubahan chat
    new MutationObserver(checkEmptyChat).observe(
        document.getElementById('chat-container'), 
        { childList: true }
    );
});

document.getElementById('clear-chat-btn').addEventListener('click', function() {
    clearChat();
});

document.addEventListener("DOMContentLoaded", () => {
    const newChatBtn = document.getElementById("new-chat-btn");
    const chatContainer = document.getElementById("chat-container");
    const noChatMessage = document.createElement("div");

    // Buat elemen untuk menampilkan pesan jika tidak ada chat
    noChatMessage.id = "no-chat-message";
    noChatMessage.className = "welcome-message";
    noChatMessage.innerHTML = "<p>Anda belum membuat chat sama sekali.</p>";
    chatContainer.appendChild(noChatMessage);



    newChatBtn.addEventListener("click", () => {
        const hasMessages = chatContainer.querySelector(".user-message") && chatContainer.querySelector(".assistant-message");

        if (!hasMessages) {
            alert("Anda harus memiliki setidaknya satu pertanyaan dan jawaban sebelum membuat chat baru.");
            return;
        }

        // Hapus chat lama dan tampilkan pesan default
        chatContainer.innerHTML = "";
        chatContainer.appendChild(noChatMessage);
        checkChatHistory();
    });

    checkChatHistory(); // Cek status tombol dan pesan saat halaman dimuat

    // Tambahkan pemantauan ketika ada pesan baru
    const observer = new MutationObserver(checkChatHistory);
    observer.observe(chatContainer, { childList: true, subtree: true });
});


function addCopyButtons() {
    document.querySelectorAll("pre code").forEach((block) => {
        const button = document.createElement("button");
        button.className = "copy-button";
        button.innerHTML = '<i class="fas fa-copy"></i> Copy';
        block.parentNode.style.position = "relative";
        block.parentNode.appendChild(button);

        button.addEventListener("click", () => {
            navigator.clipboard.writeText(block.innerText).then(() => {
                alert("Kode disalin!");
            });
        });
    });
}

document.addEventListener("DOMContentLoaded", addCopyButtons);

document.addEventListener("scroll", function () {
    const sidebar = document.getElementById("sidebar");
    if (sidebar.classList.contains("show")) {
        sidebar.classList.remove("show");
    }
});

// Fungsi untuk menyimpan chat saat ini
function saveCurrentChat() {
    const messages = Array.from(document.querySelectorAll('.message-wrapper')).map(msg => ({
        content: msg.querySelector('.message').textContent.trim(),
        isUser: msg.classList.contains('user-message-wrapper'),
        timestamp: msg.querySelector('.chat-timestamp')?.textContent || new Date().toLocaleTimeString()
    }));

    if (messages.length === 0) return;

    // Jika ada chat aktif, update yang ada
    if (currentChatId) {
        const index = chatHistory.findIndex(chat => chat.id === currentChatId);
        if (index !== -1) {
            chatHistory[index].messages = messages;
            chatHistory[index].lastUpdated = new Date().toISOString();
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
            return;
        }
    }

    // Jika tidak ada chat aktif, buat yang baru
    const chatTitle = messages[0].content.substring(0, 20) + (messages[0].content.length > 20 ? "..." : "");
    const newChat = {
        id: Date.now().toString(),
        title: chatTitle,
        messages: messages,
        created: new Date().toISOString(),
        lastUpdated: new Date().toISOString()
    };
    
    chatHistory.unshift(newChat);
    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
    currentChatId = newChat.id;
}
// Fungsi untuk mendeteksi apakah ada pesan baru yang belum disimpan
function hasUnsavedChanges(chatId) {
    const chat = chatHistory.find(c => c.id === chatId);
    if (!chat) return false;
    
    const currentMessages = Array.from(document.querySelectorAll('.message-wrapper')).map(msg => {
        const messageDiv = msg.querySelector('.message');
        let content = '';
        let imageUrl = '';
        
        const img = messageDiv.querySelector('img');
        if (img) {
            imageUrl = img.src;
            content = messageDiv.textContent.trim();
        } else {
            content = messageDiv.textContent.trim();
        }
        
        return {
            content: content,
            isUser: msg.classList.contains('user-message-wrapper'),
            imageUrl: imageUrl
        };
    });
    
    return JSON.stringify(currentMessages) !== JSON.stringify(chat.messages);
}
 	</script>
</body>
</html>